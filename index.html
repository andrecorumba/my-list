<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tarefas</title>
    
    <script>
      tailwind.config = {
        darkMode: 'class'
      }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Lógica de tema para evitar "flash" ao carregar a página
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else if (theme === 'light') {
            document.documentElement.classList.remove('dark');
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .tab-content.hidden {
            opacity: 0;
            transform: translateY(10px);
            position: absolute;
            pointer-events: none;
        }
        /* Regras para a visibilidade dos ícones de tema */
        #theme-icon-sun { display: none; }
        #theme-icon-moon { display: block; }
        .dark #theme-icon-sun { display: block; }
        .dark #theme-icon-moon { display: none; }

        /* Estilo para a notificação (toast) */
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            pointer-events: none;
        }
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <header class="relative mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">Gestor de Tarefas</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Organize as suas tarefas, projetos e lista de leitura num só lugar.</p>
            
            <button id="theme-toggle" type="button" class="absolute top-0 right-0 p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm">
                <svg id="theme-icon-moon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-icon-sun" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </header>

        <main class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 min-h-[500px]">
            <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                <nav class="flex space-x-4 -mb-px" aria-label="Tabs">
                    <button id="tab-inbox" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Caixa de Entrada <span id="inbox-count" class="count-badge">0</span>
                    </button>
                    <button id="tab-projects" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Projetos <span id="projects-count" class="count-badge">0</span>
                    </button>
                    <button id="tab-reading" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Lista de Leitura <span id="reading-count" class="count-badge">0</span>
                    </button>
                </nav>
            </div>

            <div class="relative">
                <div id="content-inbox" class="tab-content">
                    <form id="inbox-form" class="flex gap-3 mb-6">
                        <input type="text" id="inbox-input" placeholder="Adicione um novo item à sua caixa de entrada..." class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500" required>
                        <button type="submit" class="text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800">Adicionar</button>
                    </form>
                    <ul id="inbox-list" class="space-y-2"></ul>
                </div>

                <div id="content-projects" class="tab-content hidden">
                    <form id="project-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
                        <input type="text" id="project-task-input" placeholder="Insira uma tarefa..." class="sm:col-span-2 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500" required>
                        <select id="project-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500">
                            <option value="new-project">Criar Novo Projeto</option>
                        </select>
                        <input type="text" id="new-project-input" placeholder="Nome do novo projeto..." class="sm:col-span-2 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500">
                        <button type="submit" class="sm:col-span-1 text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800">Adicionar Tarefa</button>
                    </form>
                    <div id="project-list" class="space-y-4"></div>
                </div>

                <div id="content-reading" class="tab-content hidden">
                    <form id="reading-form" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
                        <input type="text" id="reading-title-input" placeholder="Título..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500" required>
                        <input type="url" id="reading-link-input" placeholder="https://exemplo.com" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500" required>
                        <button type="submit" class="sm:col-span-2 text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800">Adicionar à Lista</button>
                    </form>
                    <ul id="reading-list" class="space-y-2"></ul>
                </div>
            </div>
        </main>
        
        <footer class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="export-csv" class="w-full sm:w-auto text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">Exportar para CSV</button>
            <button id="import-csv" class="w-full sm:w-auto text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Importar de CSV</button>
            <input type="file" id="csv-file-input" class="hidden" accept=".csv">
        </footer>
    </div>

    <div id="toast-notification" class="bg-gray-900 dark:bg-gray-100 text-white dark:text-black py-2 px-5 rounded-lg shadow-xl">
        <p id="toast-message"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SELEÇÃO DE ELEMENTOS DO DOM ---
            const tabs = {
                inbox: document.getElementById('tab-inbox'),
                projects: document.getElementById('tab-projects'),
                reading: document.getElementById('tab-reading'),
            };
            const contents = {
                inbox: document.getElementById('content-inbox'),
                projects: document.getElementById('content-projects'),
                reading: document.getElementById('content-reading'),
            };
            const counts = {
                inbox: document.getElementById('inbox-count'),
                projects: document.getElementById('projects-count'),
                reading: document.getElementById('reading-count'),
            };
            const lists = {
                inbox: document.getElementById('inbox-list'),
                projects: document.getElementById('project-list'),
                reading: document.getElementById('reading-list'),
            };
            const forms = {
                inbox: document.getElementById('inbox-form'),
                projects: document.getElementById('project-form'),
                reading: document.getElementById('reading-form'),
            };
            const inputs = {
                inbox: document.getElementById('inbox-input'),
                projectTask: document.getElementById('project-task-input'),
                projectSelect: document.getElementById('project-select'),
                newProject: document.getElementById('new-project-input'),
                readingTitle: document.getElementById('reading-title-input'),
                readingLink: document.getElementById('reading-link-input'),
            };
            const exportBtn = document.getElementById('export-csv');
            const importBtn = document.getElementById('import-csv');
            const fileInput = document.getElementById('csv-file-input');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');

            // --- ESTADO DA APLICAÇÃO ---
            let state = {
                inbox: [],    // Formato: { id: '...', text: '...' }
                projects: [], // Formato: { id: '...', task: '...', project: '...' }
                reading: [],  // Formato: { id: '...', title: '...', link: '...' }
                activeTab: 'inbox'
            };

            // --- FUNÇÕES AUXILIARES ---
            const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

            let toastTimeout;
            const showToast = (message) => {
                clearTimeout(toastTimeout);
                toastMessage.textContent = message;
                toast.classList.add('show');
                toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000); 
            };

            const getProjectColors = (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = hash % 360;
                return {
                    bg: `hsl(${h}, 80%, 90%)`, text: `hsl(${h}, 60%, 30%)`,
                    darkBg: `hsl(${h}, 30%, 25%)`, darkText: `hsl(${h}, 70%, 85%)`,
                };
            };

            // --- GESTÃO DE DADOS (LOCAL STORAGE) ---
            const saveData = () => {
                localStorage.setItem('taskManagerData', JSON.stringify(state));
            };

            const loadData = () => {
                const data = localStorage.getItem('taskManagerData');
                if (data) {
                    state = JSON.parse(data);
                }
            };

            // --- LÓGICA DE RENDERIZAÇÃO (ATUALIZAÇÃO DA UI) ---
            const render = () => {
                renderTabs();
                renderInbox();
                renderProjects();
                renderReading();
                updateCounts();
                saveData();
            };
            
            const renderTabs = () => {
                Object.keys(tabs).forEach(key => {
                    const tab = tabs[key];
                    const content = contents[key];
                    const countBadge = tab.querySelector('.count-badge');
                    
                    const activeClasses = ['border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400'];
                    const inactiveClasses = ['border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-200', 'hover:border-gray-300', 'dark:hover:border-gray-500'];
                    const activeBadgeClasses = ['bg-indigo-100', 'text-indigo-600', 'dark:bg-indigo-900', 'dark:text-indigo-300', 'ml-2', 'px-2.5', 'py-0.5', 'rounded-full', 'text-xs', 'font-medium'];
                    const inactiveBadgeClasses = ['bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300', 'ml-2', 'px-2.5', 'py-0.5', 'rounded-full', 'text-xs', 'font-medium'];

                    if (key === state.activeTab) {
                        tab.classList.remove(...inactiveClasses); tab.classList.add(...activeClasses);
                        countBadge.classList.remove(...inactiveBadgeClasses); countBadge.classList.add(...activeBadgeClasses);
                        content.classList.remove('hidden');
                    } else {
                        tab.classList.remove(...activeClasses); tab.classList.add(...inactiveClasses);
                        countBadge.classList.remove(...activeBadgeClasses); countBadge.classList.add(...inactiveBadgeClasses);
                        content.classList.add('hidden');
                    }
                });
            };

            const createListItem = (content, onDelete) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600/50';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-grow pr-4';
                contentDiv.innerHTML = content;
                li.appendChild(contentDiv);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>`;
                deleteBtn.className = 'text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400 p-1 rounded transition-colors flex-shrink-0';
                deleteBtn.setAttribute('aria-label', 'Apagar item');
                deleteBtn.onclick = onDelete;
                
                li.appendChild(deleteBtn);
                return li;
            };

            const renderInbox = () => {
                lists.inbox.innerHTML = '';
                state.inbox.forEach(item => {
                    const li = createListItem(item.text, () => {
                        state.inbox = state.inbox.filter(i => i.id !== item.id);
                        render();
                    });
                    lists.inbox.appendChild(li);
                });
            };

            const renderProjects = () => {
                lists.projects.innerHTML = '';
                const projectsGrouped = state.projects.reduce((acc, item) => {
                    acc[item.project] = acc[item.project] || [];
                    acc[item.project].push(item);
                    return acc;
                }, {});

                const currentProjectSelection = inputs.projectSelect.value;
                inputs.projectSelect.innerHTML = '<option value="new-project">Criar Novo Projeto</option>';
                Object.keys(projectsGrouped).sort().forEach(projectName => {
                    const option = document.createElement('option');
                    option.value = projectName; option.textContent = projectName;
                    inputs.projectSelect.appendChild(option);
                });
                if (Object.keys(projectsGrouped).includes(currentProjectSelection)) {
                    inputs.projectSelect.value = currentProjectSelection;
                }

                Object.keys(projectsGrouped).sort().forEach(projectName => {
                    const projectContainer = document.createElement('div');
                    const title = document.createElement('h3');
                    const colors = getProjectColors(projectName);
                    title.textContent = projectName;
                    title.className = 'text-lg font-semibold mb-2 p-2 rounded-md inline-block transition-colors';
                    title.style.backgroundColor = document.documentElement.classList.contains('dark') ? colors.darkBg : colors.bg;
                    title.style.color = document.documentElement.classList.contains('dark') ? colors.darkText : colors.text;
                    projectContainer.appendChild(title);
                    
                    const ul = document.createElement('ul');
                    ul.className = 'space-y-2';
                    projectsGrouped[projectName].forEach(task => {
                        const li = createListItem(task.task, () => {
                            state.projects = state.projects.filter(p => p.id !== task.id);
                            render();
                        });
                        ul.appendChild(li);
                    });
                    
                    projectContainer.appendChild(ul);
                    lists.projects.appendChild(projectContainer);
                });
                
                inputs.newProject.style.display = inputs.projectSelect.value === 'new-project' ? 'block' : 'none';
            };

            const renderReading = () => {
                lists.reading.innerHTML = '';
                state.reading.forEach(item => {
                    const content = `<a href="${item.link}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium">${item.title}</a><span class="text-gray-500 dark:text-gray-400 text-sm ml-2">(${new URL(item.link).hostname})</span>`;
                    const li = createListItem(content, () => {
                        state.reading = state.reading.filter(r => r.id !== item.id);
                        render();
                    });
                    lists.reading.appendChild(li);
                });
            };

            const updateCounts = () => {
                counts.inbox.textContent = state.inbox.length;
                const uniqueProjects = new Set(state.projects.map(p => p.project));
                counts.projects.textContent = uniqueProjects.size;
                counts.reading.textContent = state.reading.length;
            };

            // --- EVENT LISTENERS (OUVINTES DE EVENTOS) ---
            themeToggleBtn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                render(); // CORREÇÃO: Chamar render() para redesenhar toda a UI
            });

            Object.keys(tabs).forEach(key => {
                tabs[key].addEventListener('click', () => {
                    state.activeTab = key;
                    render();
                });
            });

            forms.inbox.addEventListener('submit', (e) => {
                e.preventDefault();
                const value = inputs.inbox.value.trim();
                if (value) {
                    state.inbox.push({ id: generateId(), text: value });
                    inputs.inbox.value = '';
                    render();
                }
            });
            
            inputs.projectSelect.addEventListener('change', renderProjects);

            forms.projects.addEventListener('submit', (e) => {
                e.preventDefault();
                const task = inputs.projectTask.value.trim();
                let project = inputs.projectSelect.value;
                if (project === 'new-project') {
                    project = inputs.newProject.value.trim();
                }
                if (task && project) {
                    state.projects.push({ id: generateId(), task, project });
                    inputs.projectTask.value = '';
                    inputs.newProject.value = '';
                    render();
                } else {
                    showToast('Por favor, preencha a tarefa e o nome do projeto.');
                }
            });

            forms.reading.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = inputs.readingTitle.value.trim();
                const link = inputs.readingLink.value.trim();
                if (title && link) {
                    try {
                        new URL(link);
                        state.reading.push({ id: generateId(), title, link });
                        inputs.readingTitle.value = '';
                        inputs.readingLink.value = '';
                        render();
                    } catch (_) {
                        showToast('Por favor, insira um link válido.');
                    }
                }
            });

            // --- FUNCIONALIDADE DE IMPORTAÇÃO/EXPORTAÇÃO CSV ---
            const escapeCsvCell = (cell) => {
                if(typeof cell !== 'string') cell = String(cell);
                if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                    return `"${cell.replace(/"/g, '""')}"`;
                }
                return cell;
            };

            const parseCsvRow = (row) => {
                const result = []; let current = ''; let inQuotes = false;
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    if (char === '"') {
                        if (inQuotes && row[i + 1] === '"') {
                            current += '"'; i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim()); current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };

            exportBtn.addEventListener('click', () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "id,type,value1,value2\n";
                state.inbox.forEach(item => csvContent += `${escapeCsvCell(item.id)},Inbox,${escapeCsvCell(item.text)},\n`);
                state.projects.forEach(item => csvContent += `${escapeCsvCell(item.id)},Project,${escapeCsvCell(item.task)},${escapeCsvCell(item.project)}\n`);
                state.reading.forEach(item => csvContent += `${escapeCsvCell(item.id)},Reading,${escapeCsvCell(item.title)},${escapeCsvCell(item.link)}\n`);
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "gestor_de_tarefas.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            importBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        if (!text) throw new Error("O ficheiro está vazio.");
                        
                        const existingIds = new Set([
                            ...state.inbox.map(i => i.id),
                            ...state.projects.map(p => p.id),
                            ...state.reading.map(r => r.id)
                        ]);

                        const rows = text.split('\n').slice(1);
                        let importedCount = 0;

                        rows.forEach(row => {
                            if (row.trim() === '') return;
                            const columns = parseCsvRow(row);
                            
                            // --- INÍCIO DA CORREÇÃO CSV ---
                            let id = columns[0]?.trim();
                            const type = columns[1]?.trim();
                            const val1 = columns[2]?.trim();
                            const val2 = columns[3]?.trim();

                            // Se o ID for nulo, '0', ou já existir, gera um novo.
                            if (!id || id === '0' || existingIds.has(id)) {
                                id = generateId();
                            }

                            let itemAdded = false;
                            if (type === 'Inbox' && val1) {
                                state.inbox.push({ id, text: val1 });
                                itemAdded = true;
                            } else if (type === 'Project' && val1 && val2) {
                                state.projects.push({ id, task: val1, project: val2 });
                                itemAdded = true;
                            } else if (type === 'Reading' && val1 && val2) {
                                state.reading.push({ id, title: val1, link: val2 });
                                itemAdded = true;
                            }

                            if (itemAdded) {
                                // Adiciona o ID (novo ou antigo) ao conjunto para evitar duplicados dentro do mesmo arquivo
                                existingIds.add(id);
                                importedCount++;
                            }
                            // --- FIM DA CORREÇÃO CSV ---
                        });

                        if (importedCount === 0) {
                            showToast("Nenhum item novo para importar.");
                        } else {
                            render();
                            showToast(`${importedCount} item(ns) importado(s) com sucesso!`);
                        }
                    } catch (error) {
                        console.error('Erro ao importar CSV:', error);
                        showToast(`Erro ao importar: ${error.message}`);
                    } finally {
                        fileInput.value = '';
                    }
                };
                reader.onerror = () => {
                    showToast('Não foi possível ler o ficheiro.');
                    fileInput.value = '';
                };
                reader.readAsText(file);
            });

            // --- INICIALIZAÇÃO DA APLICAÇÃO ---
            inputs.newProject.style.display = 'none';
            loadData();
            render();
        });
    </script>
</body>
</html>